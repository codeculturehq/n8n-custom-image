name: ğŸ‘€ Check for new n8n stable releases and build new custom image releases

on:
  schedule:
    - cron: '0 8 * * *' # Every day at 8am
  workflow_dispatch:

jobs:
  check-v1:
    name: ğŸ” Check n8n v1 releases
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      has_new_release: ${{ steps.check.outputs.has_new_release }}
      version: ${{ steps.check.outputs.version }}

    steps:
      - name: ğŸ” Get latest n8n v1 release
        id: n8n
        run: |
          LATEST=$(curl -s "https://api.github.com/repos/n8n-io/n8n/releases" | \
            jq -r '[.[] | select(.tag_name | startswith("n8n@1.")) | select(.prerelease == false)] | .[0].tag_name' | \
            sed 's/n8n@//')
          echo "Latest n8n v1: $LATEST"
          echo "version=$LATEST" >> $GITHUB_OUTPUT

      - name: ğŸ‘€ Get our latest v1 custom image release
        id: ours
        run: |
          OUR_LATEST=$(curl -s "https://api.github.com/repos/codeculturehq/n8n-custom-image/releases" | \
            jq -r '[.[] | select(.tag_name | startswith("n8n@1.")) | select(.prerelease == false)] | .[0].tag_name // "none"' | \
            sed 's/n8n@//' | sed 's/-[0-9]*$//')
          echo "Our latest v1: $OUR_LATEST"
          echo "version=$OUR_LATEST" >> $GITHUB_OUTPUT

      - name: ğŸ¤² Check if new release needed
        id: check
        run: |
          N8N_VERSION="${{ steps.n8n.outputs.version }}"
          OUR_VERSION="${{ steps.ours.outputs.version }}"

          if [ -z "$N8N_VERSION" ] || [ "$N8N_VERSION" = "null" ]; then
            echo "No n8n v1 release found"
            echo "has_new_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "$OUR_VERSION" = "none" ] || [ "$OUR_VERSION" = "null" ]; then
            echo "ğŸ†• First v1 release!"
            echo "has_new_release=true" >> $GITHUB_OUTPUT
            echo "version=$N8N_VERSION" >> $GITHUB_OUTPUT
            exit 0
          fi

          LATEST=$(echo -e "$OUR_VERSION\n$N8N_VERSION" | sort -V | tail -n1)
          if [ "$OUR_VERSION" != "$LATEST" ]; then
            echo "ğŸ¤© New v1 release: $N8N_VERSION"
            echo "has_new_release=true" >> $GITHUB_OUTPUT
            echo "version=$N8N_VERSION" >> $GITHUB_OUTPUT
          else
            echo "ğŸ‘ v1 is up to date"
            echo "has_new_release=false" >> $GITHUB_OUTPUT
          fi

  check-v2:
    name: ğŸ” Check n8n v2 releases
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      has_new_release: ${{ steps.check.outputs.has_new_release }}
      version: ${{ steps.check.outputs.version }}

    steps:
      - name: ğŸ” Get latest n8n v2 release
        id: n8n
        run: |
          LATEST=$(curl -s "https://api.github.com/repos/n8n-io/n8n/releases" | \
            jq -r '[.[] | select(.tag_name | startswith("n8n@2.")) | select(.prerelease == false)] | .[0].tag_name' | \
            sed 's/n8n@//')
          echo "Latest n8n v2: $LATEST"
          echo "version=$LATEST" >> $GITHUB_OUTPUT

      - name: ğŸ‘€ Get our latest v2 custom image release
        id: ours
        run: |
          OUR_LATEST=$(curl -s "https://api.github.com/repos/codeculturehq/n8n-custom-image/releases" | \
            jq -r '[.[] | select(.tag_name | startswith("n8n@2.")) | select(.prerelease == false)] | .[0].tag_name // "none"' | \
            sed 's/n8n@//' | sed 's/-[0-9]*$//')
          echo "Our latest v2: $OUR_LATEST"
          echo "version=$OUR_LATEST" >> $GITHUB_OUTPUT

      - name: ğŸ¤² Check if new release needed
        id: check
        run: |
          N8N_VERSION="${{ steps.n8n.outputs.version }}"
          OUR_VERSION="${{ steps.ours.outputs.version }}"

          if [ -z "$N8N_VERSION" ] || [ "$N8N_VERSION" = "null" ]; then
            echo "No n8n v2 release found"
            echo "has_new_release=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ "$OUR_VERSION" = "none" ] || [ "$OUR_VERSION" = "null" ]; then
            echo "ğŸ†• First v2 release!"
            echo "has_new_release=true" >> $GITHUB_OUTPUT
            echo "version=$N8N_VERSION" >> $GITHUB_OUTPUT
            exit 0
          fi

          LATEST=$(echo -e "$OUR_VERSION\n$N8N_VERSION" | sort -V | tail -n1)
          if [ "$OUR_VERSION" != "$LATEST" ]; then
            echo "ğŸ¤© New v2 release: $N8N_VERSION"
            echo "has_new_release=true" >> $GITHUB_OUTPUT
            echo "version=$N8N_VERSION" >> $GITHUB_OUTPUT
          else
            echo "ğŸ‘ v2 is up to date"
            echo "has_new_release=false" >> $GITHUB_OUTPUT
          fi

  build-v1:
    name: ğŸ³ Build v1
    needs: check-v1
    if: ${{ needs.check-v1.outputs.has_new_release == 'true' }}
    uses: ./.github/workflows/build-and-push.yml
    secrets: inherit
    with:
      n8n_version: ${{ needs.check-v1.outputs.version }}
      major_version: '1'

  build-v2:
    name: ğŸ³ Build v2
    needs: check-v2
    if: ${{ needs.check-v2.outputs.has_new_release == 'true' }}
    uses: ./.github/workflows/build-and-push.yml
    secrets: inherit
    with:
      n8n_version: ${{ needs.check-v2.outputs.version }}
      major_version: '2'
