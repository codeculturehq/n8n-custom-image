name: ðŸ”„ Rebuild images on Dockerfile/workflow changes

on:
  push:
    branches:
      - main
    paths:
      - 'Dockerfile'
      - '.github/workflows/build-and-push.yml'
      - '.github/workflows/create-new-release-on-push.yml'

jobs:
  check-and-prepare:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    outputs:
      should_build: ${{ steps.check_changes.outputs.relevant_changes }}
      v1_version: ${{ steps.versions.outputs.v1_version }}
      v1_suffix: ${{ steps.versions.outputs.v1_suffix }}
      v2_version: ${{ steps.versions.outputs.v2_version }}
      v2_suffix: ${{ steps.versions.outputs.v2_suffix }}

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ðŸ” Check if relevant files changed
        id: check_changes
        run: |
          changed_files=$(git diff --name-only HEAD^ HEAD)
          echo "Changed files:"
          echo "$changed_files"

          relevant_changes=false
          if echo "$changed_files" | grep -E "(Dockerfile|\.github/workflows/)" > /dev/null; then
            relevant_changes=true
            echo "âœ… Relevant files changed, proceeding with builds"
          else
            echo "âŒ No relevant files changed, skipping builds"
          fi
          echo "relevant_changes=$relevant_changes" >> $GITHUB_OUTPUT

      - name: ðŸ”¢ Get versions and calculate suffixes
        id: versions
        if: steps.check_changes.outputs.relevant_changes == 'true'
        run: |
          # Get latest n8n releases for v1 and v2
          V1_LATEST=$(curl -s "https://api.github.com/repos/n8n-io/n8n/releases" | \
            jq -r '[.[] | select(.tag_name | startswith("n8n@1.")) | select(.prerelease == false)] | .[0].tag_name' | \
            sed 's/n8n@//')
          V2_LATEST=$(curl -s "https://api.github.com/repos/n8n-io/n8n/releases" | \
            jq -r '[.[] | select(.tag_name | startswith("n8n@2.")) | select(.prerelease == false)] | .[0].tag_name' | \
            sed 's/n8n@//')

          echo "Latest n8n v1: $V1_LATEST"
          echo "Latest n8n v2: $V2_LATEST"

          # Get our latest releases
          OUR_RELEASES=$(curl -s "https://api.github.com/repos/codeculturehq/n8n-custom-image/releases")

          # Calculate suffix for v1
          OUR_V1=$(echo "$OUR_RELEASES" | jq -r '[.[] | select(.tag_name | startswith("n8n@1."))] | .[0].tag_name // "none"' | sed 's/n8n@//')
          if [ "$OUR_V1" != "none" ] && [ "$(echo "$OUR_V1" | sed 's/-[0-9]*$//')" = "$V1_LATEST" ]; then
            # Same version, increment suffix
            CURRENT_SUFFIX=$(echo "$OUR_V1" | grep -o '\-[0-9]*$' | tr -d '-' || echo "0")
            V1_SUFFIX="-$((CURRENT_SUFFIX + 1))"
          else
            V1_SUFFIX=""
          fi

          # Calculate suffix for v2
          OUR_V2=$(echo "$OUR_RELEASES" | jq -r '[.[] | select(.tag_name | startswith("n8n@2."))] | .[0].tag_name // "none"' | sed 's/n8n@//')
          if [ "$OUR_V2" != "none" ] && [ "$(echo "$OUR_V2" | sed 's/-[0-9]*$//')" = "$V2_LATEST" ]; then
            # Same version, increment suffix
            CURRENT_SUFFIX=$(echo "$OUR_V2" | grep -o '\-[0-9]*$' | tr -d '-' || echo "0")
            V2_SUFFIX="-$((CURRENT_SUFFIX + 1))"
          else
            V2_SUFFIX=""
          fi

          echo "v1_version=$V1_LATEST" >> $GITHUB_OUTPUT
          echo "v1_suffix=$V1_SUFFIX" >> $GITHUB_OUTPUT
          echo "v2_version=$V2_LATEST" >> $GITHUB_OUTPUT
          echo "v2_suffix=$V2_SUFFIX" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Will build: v1=$V1_LATEST$V1_SUFFIX, v2=$V2_LATEST$V2_SUFFIX"

  build-v1:
    needs: check-and-prepare
    if: ${{ needs.check-and-prepare.outputs.should_build == 'true' && needs.check-and-prepare.outputs.v1_version != '' && needs.check-and-prepare.outputs.v1_version != 'null' }}
    uses: ./.github/workflows/build-and-push.yml
    secrets: inherit
    with:
      n8n_version: ${{ needs.check-and-prepare.outputs.v1_version }}
      major_version: '1'
      next_version_suffix: ${{ needs.check-and-prepare.outputs.v1_suffix }}

  build-v2:
    needs: check-and-prepare
    if: ${{ needs.check-and-prepare.outputs.should_build == 'true' && needs.check-and-prepare.outputs.v2_version != '' && needs.check-and-prepare.outputs.v2_version != 'null' }}
    uses: ./.github/workflows/build-and-push.yml
    secrets: inherit
    with:
      n8n_version: ${{ needs.check-and-prepare.outputs.v2_version }}
      major_version: '2'
      next_version_suffix: ${{ needs.check-and-prepare.outputs.v2_suffix }}
