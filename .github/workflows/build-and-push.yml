name: ðŸ“¦ Build custom Docker image and push to Docker Hub

# Workflow triggered manually (GitHub UI) or programmatically by the check-n8n-new-release workflow
on:
  workflow_call:
    inputs:
      n8n_version:
        description: 'n8n version to build. Example: 1.20.0'
        required: true
        type: string
      major_version:
        description: 'Major version (1 or 2). Determines tagging strategy.'
        required: false
        type: string
        default: ''
      next_version_suffix:
        description: 'Next version suffix to compare with the new release. Example: -1'
        required: false
        type: string
  workflow_dispatch:
    inputs:
      n8n_version:
        description: 'n8n version to build. Example: 1.20.0 or 2.0.2'
        required: true
        type: string
      major_version:
        description: 'Major version (1 or 2). Leave empty to auto-detect.'
        required: false
        type: string
        default: ''
      next_version_suffix:
        description: 'Next version suffix. Example: -1'
        required: false
        type: string

jobs:
  build-push-docker-image:
    name: ðŸ³ Build and push Docker image
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      DOCKER_IMAGE: ${{ vars.DOCKER_IMAGE || 'tinod/n8n-custom-image' }}
      DOCKER_IMAGE_SECURE: ${{ vars.DOCKER_IMAGE_SECURE || 'tinod/n8n-custom-image-secure' }}
    steps:
      - uses: actions/checkout@v4

      - name: ðŸ”¢ Determine major version and tags
        id: tags
        run: |
          VERSION="${{ inputs.n8n_version }}"
          MAJOR="${{ inputs.major_version }}"
          SUFFIX="${{ inputs.next_version_suffix }}"
          IMAGE="${DOCKER_IMAGE}"
          IMAGE_SECURE="${DOCKER_IMAGE_SECURE}"

          # Auto-detect major version if not provided
          if [ -z "$MAJOR" ]; then
            MAJOR=$(echo "$VERSION" | cut -d'.' -f1)
          fi

          echo "major=$MAJOR" >> $GITHUB_OUTPUT

          # Build tag list
          TAGS_DEFAULT="${IMAGE}:${VERSION}${SUFFIX}"
          TAGS_DEFAULT="$TAGS_DEFAULT,${IMAGE}:v${MAJOR}"

          TAGS_SECURE="${IMAGE_SECURE}:${VERSION}${SUFFIX}"
          TAGS_SECURE="$TAGS_SECURE,${IMAGE_SECURE}:v${MAJOR}"

          # v2 gets 'latest' tag
          if [ "$MAJOR" = "2" ]; then
            TAGS_DEFAULT="$TAGS_DEFAULT,${IMAGE}:latest"
            TAGS_SECURE="$TAGS_SECURE,${IMAGE_SECURE}:latest"
          fi

          echo "tags_default=$TAGS_DEFAULT" >> $GITHUB_OUTPUT
          echo "tags_secure=$TAGS_SECURE" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Will push tags (base): $TAGS_DEFAULT"
          echo "ðŸ“¦ Will push tags (secure): $TAGS_SECURE"

      - name: ðŸ§¹ Free disk space
        run: |
          echo "Before cleanup:"
          df -h

          # Remove unnecessary tools and libraries
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/share/swift

          # Clean apt cache
          sudo apt-get clean

          # Clean docker
          docker system prune -af

          echo "After cleanup:"
          df -h

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - uses: docker/bake-action@v5
        with:
          files: docker-bake.hcl
          targets: base,secure
          push: true
          set: |
            base.args.N8N_VERSION=${{ inputs.n8n_version }}
            secure.args.N8N_VERSION=${{ inputs.n8n_version }}
            base.tags=${{ steps.tags.outputs.tags_default }}
            secure.tags=${{ steps.tags.outputs.tags_secure }}

  create-release:
    name: ðŸ·ï¸ Create GitHub Release
    needs: build-push-docker-image
    runs-on: ubuntu-latest
    timeout-minutes: 2
    permissions:
      contents: write
    steps:
      - uses: ncipollo/release-action@v1
        with:
          commit: main
          tag: n8n@${{ inputs.n8n_version }}${{ inputs.next_version_suffix }}

  notify-new-release:
    name: ðŸ’¬ Notify new image release in Slack
    needs: build-push-docker-image
    runs-on: ubuntu-latest
    timeout-minutes: 2
    env:
      DOCKER_IMAGE: ${{ vars.DOCKER_IMAGE || 'tinod/n8n-custom-image' }}
      DOCKER_IMAGE_SECURE: ${{ vars.DOCKER_IMAGE_SECURE || 'tinod/n8n-custom-image-secure' }}
    steps:
      - name: ðŸ”¢ Get major version
        id: major
        run: |
          MAJOR="${{ inputs.major_version }}"
          if [ -z "$MAJOR" ]; then
            MAJOR=$(echo "${{ inputs.n8n_version }}" | cut -d'.' -f1)
          fi
          echo "version=$MAJOR" >> $GITHUB_OUTPUT

      - uses: slackapi/slack-github-action@v2
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.RELEASE_NOTIFICATION__SLACK_WEBHOOK_URL }}
        with:
          webhook-type: webhook-trigger
          payload: |
            channel: #it
            text: "New n8n v${{ steps.major.outputs.version }} images pushed: ${{ inputs.n8n_version }}${{ inputs.next_version_suffix }} â†’ ${DOCKER_IMAGE} + ${DOCKER_IMAGE_SECURE} :tada:"
