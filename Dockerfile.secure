ARG N8N_VERSION=latest
ARG N8N_TAG=n8n@2.3.2
FROM n8nio/n8n:${N8N_VERSION}
ARG N8N_VERSION
ENV PYTHONUNBUFFERED=1
ENV N8N_DISABLE_EXTERNAL_COMMUNICATIONS=true \
    N8N_DIAGNOSTICS_ENABLED=false \
    N8N_VERSION_NOTIFICATIONS_ENABLED=false \
    N8N_VERSION_NOTIFICATIONS_WHATS_NEW_ENABLED=false \
    N8N_DYNAMIC_BANNERS_ENABLED=false \
    N8N_TEMPLATES_ENABLED=false \
    N8N_PERSONALIZATION_ENABLED=false \
    N8N_LICENSE_AUTO_RENEW_ENABLED=false \
    N8N_LICENSE_SERVICE_ENABLED=false

RUN if [ -z "$N8N_VERSION" ] ; then echo "âœ‹ The N8N_VERSION argument is missing!" ; exit 1; fi

USER root

RUN if command -v apk >/dev/null 2>&1; then \
    printf '%s\n' \
      "https://dl-cdn.alpinelinux.org/alpine/v3.22/main" \
      "https://dl-cdn.alpinelinux.org/alpine/v3.22/community" > /etc/apk/repositories; \
    apk update && apk upgrade --no-cache openssl libssl3 libcrypto3; \
    apk add --no-cache \
      chromium \
      nss \
      freetype \
      harfbuzz \
      ttf-freefont \
      yarn \
      curl \
      py3-pip \
      python3 \
      py3-setuptools \
      pandoc \
      ca-certificates \
      ffmpeg \
      git \
      tectonic; \
  elif command -v apt-get >/dev/null 2>&1; then \
    apt-get update; \
    apt-get install -y --no-install-recommends \
      chromium \
      libnss3 \
      libfreetype6 \
      libharfbuzz0b \
      fonts-freefont-ttf \
      yarn \
      curl \
      python3 \
      python3-pip \
      python3-setuptools \
      pandoc \
      ca-certificates \
      ffmpeg \
      git \
      tectonic; \
    rm -rf /var/lib/apt/lists/*; \
  else \
    echo "No supported package manager; skipping OS package install."; \
  fi


# Tell Puppeteer to skip installing Chrome. We'll be using the installed package.
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true \
    PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

RUN npm install -g cryptr

# Install yt-dlp
RUN if command -v curl >/dev/null 2>&1; then \
    curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp \
      && chmod a+rx /usr/local/bin/yt-dlp; \
  else \
    echo "curl not available; skipping yt-dlp install."; \
  fi

# Install the community node
# RUN cd /usr/local/lib/node_modules/n8n && \
#  yarn add @endcycles/n8n-nodes-youtube-transcript n8n-nodes-puppeteer n8n-nodes-advanced-flow n8n-nodes-elevenlabs n8n-nodes-browserless n8n-nodes-mcp n8n-nodes-playwright

USER node

# Install custom n8n nodes
#RUN mkdir -p ~/pymupdfllm 

# Install the Python package within the virtual environment
# RUN pip install -U --break-system-packages --only-binary :all: --target ~/pymupdfllm pymupdf4llm
RUN if command -v python3 >/dev/null 2>&1; then \
    python3 -m venv /home/node/venv; \
  else \
    echo "python3 not available; skipping venv creation."; \
  fi
ENV PATH="/home/node/venv/bin:${PATH}"
RUN if command -v python3 >/dev/null 2>&1; then \
    python3 -m pip install --break-system-packages pipx; \
  else \
    echo "python3 not available; skipping pipx install."; \
  fi
# RUN pip install -U --break-system-packages pymupdf4llm
# RUN pip install -U --break-system-packages --only-binary :all: pymupdf4llm
