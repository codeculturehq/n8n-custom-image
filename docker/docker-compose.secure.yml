# =============================================================================
# n8n Secure Stack - Complete Docker Compose Configuration
# =============================================================================
#
# GDPR/DSGVO compliant deployment with:
# - Zero external communications (telemetry, analytics, version checks disabled)
# - PostgreSQL database with persistent storage
# - Network isolation (internal network, no egress by default)
# - Health checks for reliability
# - Volume mounts for data persistence
# - Queue mode support (optional Redis)
#
# Usage:
#   docker compose -f docker/docker-compose.secure.yml up -d
#
# For air-gapped environments, see: docs/AIR-GAPPED-DEPLOYMENT.md
# =============================================================================

name: n8n-secure

services:
  # ===========================================================================
  # n8n Workflow Automation
  # ===========================================================================
  n8n:
    image: tinod/n8n-custom-image-secure:latest
    container_name: n8n
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "${N8N_PORT:-5678}:5678"
    networks:
      - n8n-internal
    volumes:
      # Persistent data storage
      - n8n-data:/home/node/.n8n
      # Custom nodes (optional)
      - n8n-custom-nodes:/home/node/.n8n/custom
      # Shared files for workflows
      - n8n-files:/files
    environment:
      # =========================================================================
      # Core Configuration
      # =========================================================================
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678/}
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE:-UTC}

      # =========================================================================
      # Database Configuration (PostgreSQL)
      # =========================================================================
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${POSTGRES_DB:-n8n}
      - DB_POSTGRESDB_USER=${POSTGRES_USER:-n8n}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD:-n8n_secure_password}
      - DB_POSTGRESDB_SCHEMA=public

      # =========================================================================
      # GDPR/DSGVO Privacy - COMPLETE EXTERNAL COMMUNICATIONS DISABLED
      # =========================================================================
      # Master kill switch for all external communications
      - N8N_DISABLE_EXTERNAL_COMMUNICATIONS=true

      # Telemetry & Analytics (disabled)
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_DIAGNOSTICS_POSTHOG_DISABLE_RECORDING=true
      - N8N_DIAGNOSTICS_POSTHOG_API_KEY=

      # Version checks & banners (disabled)
      - N8N_VERSION_NOTIFICATIONS_ENABLED=false
      - N8N_HIRING_BANNER_ENABLED=false

      # Templates & personalization (disabled - requires external API)
      - N8N_TEMPLATES_ENABLED=false
      - N8N_PERSONALIZATION_ENABLED=false
      - N8N_ONBOARDING_FLOW_DISABLED=true

      # AI features (disabled - requires external API)
      - N8N_AI_ENABLED=false

      # Community packages (disabled - requires NPM registry)
      - N8N_COMMUNITY_PACKAGES_ENABLED=false
      - N8N_REINSTALL_MISSING_PACKAGES=false

      # =========================================================================
      # License Configuration (Offline Mode)
      # =========================================================================
      - N8N_LICENSE_SERVICE_ENABLED=false
      - N8N_LICENSE_OFFLINE_MODE=true
      - N8N_LICENSE_AUTO_RENEW_ENABLED=false

      # Optional: GDPR Feature Overrides (uncomment to enable enterprise features)
      # - N8N_LICENSE_FORCE_PLAN=Enterprise
      # - N8N_LICENSE_FORCE_FEATURES=feat:sharing,feat:ldap,feat:advancedExecutionFilters
      # - N8N_LICENSE_QUOTA_USERS_LIMIT=100
      # - N8N_LICENSE_QUOTA_WORKFLOW_HISTORY_PRUNE_LIMIT=1000

      # =========================================================================
      # Security Settings
      # =========================================================================
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:-}
      - N8N_USER_MANAGEMENT_JWT_SECRET=${N8N_JWT_SECRET:-}

      # Secure cookies (enable for HTTPS deployments)
      # - N8N_SECURE_COOKIE=true

      # Rate limiting
      - N8N_RATE_LIMIT_ENABLED=true
      - N8N_RATE_LIMIT_REQUESTS_PER_MINUTE=100

      # =========================================================================
      # Execution Settings
      # =========================================================================
      - EXECUTIONS_MODE=regular
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_ON_PROGRESS=true
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true

      # Execution data pruning (optional - uncomment to auto-delete old executions)
      # - EXECUTIONS_DATA_MAX_AGE=336
      # - EXECUTIONS_DATA_PRUNE=true

      # =========================================================================
      # Logging
      # =========================================================================
      - N8N_LOG_LEVEL=${N8N_LOG_LEVEL:-info}
      - N8N_LOG_OUTPUT=console

    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5678/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  postgres:
    image: postgres:16-alpine
    container_name: n8n-postgres
    restart: unless-stopped
    networks:
      - n8n-internal
    volumes:
      - postgres-data:/var/lib/postgresql/data
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-n8n}
      - POSTGRES_USER=${POSTGRES_USER:-n8n}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-n8n_secure_password}
      - PGDATA=/var/lib/postgresql/data/pgdata
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-n8n} -d ${POSTGRES_DB:-n8n}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ===========================================================================
  # Redis (Optional - for Queue Mode)
  # ===========================================================================
  # Uncomment this section if you need queue mode for scaling
  #
  # redis:
  #   image: redis:7-alpine
  #   container_name: n8n-redis
  #   restart: unless-stopped
  #   networks:
  #     - n8n-internal
  #   volumes:
  #     - redis-data:/data
  #   command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy volatile-lru
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #
  # When using Redis, add to n8n environment:
  #   - EXECUTIONS_MODE=queue
  #   - QUEUE_BULL_REDIS_HOST=redis
  #   - QUEUE_BULL_REDIS_PORT=6379

# =============================================================================
# Networks
# =============================================================================
networks:
  n8n-internal:
    driver: bridge
    # Enable 'internal: true' for complete network isolation (no internet egress)
    # internal: true

# =============================================================================
# Volumes
# =============================================================================
volumes:
  n8n-data:
    driver: local
  n8n-custom-nodes:
    driver: local
  n8n-files:
    driver: local
  postgres-data:
    driver: local
  # redis-data:
  #   driver: local
